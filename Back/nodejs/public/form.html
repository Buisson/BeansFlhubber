<!DOCTYPE html>
<html>
	<head>
		<title>Interface Utilisateur FlHubber</title>
		<script src="_js/jquery-3.1.1.js"></script>
		<script src="_js/socket.io.min.js"></script>
		<style>
			/*Sale à mettre dans une feuille css ;)*/
			#boitier{
				width:200px;
				height:250px;
				background-color: brown;
				margin:0 auto;
				position: relative;
				margin-top:50px;
				margin-bottom:50px;
			}
			.port{
				background-color:red;
				font-size:30px;
				position: absolute;
			}

			#port1{
				left:150px;
				top:10px;
			}
			#port2{
				left:50px;
				top:10px;
			}
			#port3{
				left:150px;
				bottom:10px;
			}
			#port4{
				left:50px;
				bottom:10px;
			}



			.namePort{
				display: none;
				/*background-color:blue;*/
				position: absolute;
				font-weight: bold;
			}

			#namePort1{
				left:150px;
				top:-30px;
			}

			#namePort2{
				top:-30px;
			}
			#namePort3{
				left:150px;
				bottom:-30px;
			}
			#namePort4{
				bottom:-30px;
			}
		</style>
	</head>
	<body>
		<H1 style='text-align:center;'> Device modifications</H1>

		<h2>Liste des devices branchés : </h2>

		<div id='boitier'>
			<span id='port1' class='port'>1</span>
			<span id='port2' class='port'>2</span>
			<span id='port3' class='port'>3</span>
			<span id='port4' class='port'>4</span>

			<div id='namePort1' class='namePort'>1</div>
			<div id='namePort2' class='namePort'>2</div>
			<div id='namePort3' class='namePort'>3</div>
			<div id='namePort4' class='namePort'>4</div>
		</div>
		<div>

		</div>

		<h2> Select Device in list: </h2>
		<select id='device' name="user">
			<option value="NOTHING">Nothing</option>
			<!--<option value="new_user">New User</option>-->

		</select>

		<div class ="form" style = "display:none">
		<h2> Now you can modifie the Device </h2>

			<div>ID : <span id="idDevice"></span></div>

			<label for = "nickname"> Surnom: </label>
			<input name = "nickname" id= "nickname"  type = "text"><br>

			<label for = "email"> Email: </label>
			<input name = "email" id= "email"  type = "text"><br>

			<label for = "timeBeforeAlert"> Temps avant alerte Mail: </label>
			<input name = "timeBeforeAlert" id= "timeBeforeAlert"  type = "text"><br>

			

			<button onclick = "updateInfo();">Edit</button>
		</div>

		<script>

		function updateInfo(){
			console.log( $("select option.selected"));

			$.post( "http://localhost:8081/form", 
				{ 
					id : $("#device").val(),
					surname : $("#nickname").val(),
					email: $(".form [name=email]").val(),
					timeBeforeAlert: $("#timeBeforeAlert").val()
				}).done(function(data){
					if(data == "OK"){
						$("#device option[value="+$("#device").val()+"]").html($("#nickname").val()); //update de la valeur dans le select...
						$(".namePort").each(function(){
							var elem = $(this);
							if(elem.attr("idd") == $("#device").val()){
								elem.html($("#nickname").val());
							}
						});
						alert("Modifications effectuées avec succès");
					}
					else{
						alert("Une erreur est survenue, veuillez essayer ulterieurement");
					}
				});

		}

		function getUsers(){
			$.get( "http://localhost:8081/getDevices", function( data ) {
				for (var i = 0; i < data.length; i++){
					if(!isDeviceAlreadyInList(data[i].id)) {
						console.log("AJOUT de ..."+data[i].id);
						$("#device").append( '<option value="'+data[i].id+'">'+data[i].name+'</option>');
					}
				}
			});
		}

		function updateForm(value){
			console.log("user selected:", value);
			if (value != "NOTHING" && value != "new_user"){
				$.get( "http://localhost:8081/user?id="+value, function( data ) {
					console.log("data",data);
					$("#idDevice").html(value);
					$(".form input[name=email]").val(data.email);
					$("#nickname").val(data.deviceName);
					$("#timeBeforeAlert").val((data.timeBeforeAlert/3600));
					$(".form").css({display: "block"});
				});
				$(".new_user").css({display: "none"});

			}else{
				$(".form").css({display: "none"});
				$(".new_user").css({display: "none"});
			}
			if(value == "new_user"){
				$(".new_user").css({display: "block"});
				$(".form").css({display: "none"});

			}
		}

		function isDeviceAlreadyInList(id){
			var find = false;
			$("#device option").each(function(){
				if(this.value == id){
					//console.log(this.value+"  VS  "+id);
					find = true;
				}
			});
			return find;
		}

		$(document).ready(function(){
			var socket = io.connect("http://localhost:8081/");
			console.log("getting infos...");
			getUsers();

			$("select").change(function(){
				updateForm($(this).val())
			})


			//Lorsqu'on recois un update ...
			socket.on('updatePorts', function(data){
			  	//alert(JSON.stringify(data));
			  	$(".namePort").attr("idd","");
			  	$(".namePort").css({"display":"none"}); //on cache tous les affichages des noms au cas ou
			  	$(".port").css({"background-color":"red"}); //on set tout les port a rouge au cas ou
			  	for(var i=0;i<data.length;i++){
			  		var numPort = data[i].portNum;
			  		var name = data[i].name;
			  		var idDev = data[i].id
			  		
			  		$("#port"+numPort).css({"background-color":"green"});// on set le port en vert
			  		
					$("#namePort"+numPort).html(name);
					$("#namePort"+numPort).attr("idd",idDev);
			  		$("#namePort"+numPort).css({"display":"block"});
			  	}

			  	getUsers();//maj de la liste deroulante
			});
		});

		</script>
	</body>
</html>